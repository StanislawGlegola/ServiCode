<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html(
        ~{::title},
        ~{::style},
        ~{::div.content},
        ~{::script}
      )}">
<head>
    <title th:text="${formMode == 'new' ? 'Dodaj Protokół' : 'Edytuj Protokół'} + ' - ServiCode'"></title>
    <style>
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
            padding: 0 6px;
        }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            padding: 4px 12px;
            margin-top: 2px;
        }
        /* Ukryj niepotrzebne listy techników */
        .select2-container--below {
            z-index: 9999;
        }
        .content > ul {
            display: none !important;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
</head>
<body>
<div class="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 th:text="${formMode == 'new' ? 'Dodaj Protokół' : 'Edytuj Protokół'}"></h2>
        <a th:href="@{/protocol}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Powrót do listy
        </a>
    </div>

    <!-- Komunikat o błędzie -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="protocolForm" th:action="@{/protocol/form/save}" method="post" th:object="${protocol}">
                <input type="hidden" id="protocolId" name="id" th:field="*{id}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="startDate" class="form-label">Data rozpoczęcia</label>
                        <input type="datetime-local" class="form-control" id="startDate" name="startDate" required
                               th:value="${protocol.startDate != null ? #temporals.format(protocol.startDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
                        <input type="hidden" th:field="*{startDate}" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="endDate" class="form-label">Data zakończenia</label>
                        <input type="datetime-local" class="form-control" id="endDate" name="endDate"
                               th:value="${protocol.endDate != null ? #temporals.format(protocol.endDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
                        <input type="hidden" th:field="*{endDate}" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="customerId" class="form-label">Klient</label>
                        <select class="form-control select2" id="customerId" th:field="*{customerId}" required onchange="updateDeviceList()">
                            <option value="">Wybierz klienta...</option>
                            <option th:each="customer : ${customers}"
                                    th:value="${customer.id}"
                                    th:text="${customer.name}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="deviceId" class="form-label">Urządzenie</label>
                        <select class="form-control select2" id="deviceId" th:field="*{deviceId}" required>
                            <option value="">Najpierw wybierz klienta...</option>
                            <option th:if="${devices != null}" th:each="device : ${devices}"
                                    th:value="${device.id}"
                                    th:text="${' (S/N: ' + device.serialNumber + ')'}">
                            </option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="technicianIds" class="form-label">Technicy</label>
                    <select class="form-control select2" id="technicianIds" th:field="*{technicianIds}" multiple required>
                        <option th:each="technician : ${technicians}"
                                th:value="${technician.id}"
                                th:text="${technician.firstName + ' ' + technician.lastName + ' (' + technician.fGaz + ')'}">
                        </option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="issueDescription" class="form-label">Opis problemu</label>
                    <textarea class="form-control" id="issueDescription" th:field="*{issueDescription}" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="workDescription" class="form-label">Opis prac</label>
                    <textarea class="form-control" id="workDescription" th:field="*{workDescription}" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="materials" class="form-label">Materiały</label>
                    <textarea class="form-control" id="materials" th:field="*{materials}" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">Uwagi</label>
                    <textarea class="form-control" id="notes" th:field="*{notes}" rows="2"></textarea>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <a th:href="@{/protocol}" class="btn btn-secondary">
                        <i class="bi bi-x-lg"></i> Anuluj
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Zapisz
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Jeśli edytujemy, już mamy klienta
        if ($("#customerId").val()) {
            updateDeviceList();
        }
    });

    function updateDeviceList() {
        const customerId = document.getElementById('customerId').value;
        const currentDeviceId = document.getElementById('deviceId').value;

        if (customerId) {
            fetch(`/device/by-customer/${customerId}`)
                .then(response => response.json())
                .then(devices => {
                    const deviceSelect = document.getElementById('deviceId');
                    deviceSelect.innerHTML = '<option value="">Wybierz urządzenie...</option>';
                    devices.forEach(device => {
                        const option = new Option(
                            `(S/N: ${device.serialNumber})`,
                            device.id
                        );
                        deviceSelect.add(option);
                    });

                    // Przywróć wybraną wartość, jeśli istnieje
                    if (currentDeviceId) {
                        deviceSelect.value = currentDeviceId;
                    }

                    $('#deviceId').trigger('change');
                });
        } else {
            const deviceSelect = document.getElementById('deviceId');
            deviceSelect.innerHTML = '<option value="">Najpierw wybierz klienta...</option>';
            $('#deviceId').trigger('change');
        }
    }
</script>
</body>
</html>